---
title: API Key Plugin
description: Generate and manage API keys for programmatic access and service-to-service authentication.
---

## Overview

The `api-key` plugin provides **API key management** for programmatic access to your application. Perfect for:

- **Service-to-service** authentication (microservices, webhooks, integrations)
- **Developer APIs** where users generate keys for their applications
- **Mobile/desktop apps** requiring long-lived authentication
- **CI/CD pipelines** and automated scripts

Key features:

- **Secure key generation** with customizable prefix and length
- **Scoped permissions** for granular access control
- **Expiration management** with configurable TTL
- **Usage tracking** (optional) for monitoring and rate limiting
- **Multiple keys per user** with descriptive names
- **Background cleanup** of expired keys

<Callout title="One-time key display" type="warn">
  API keys are only shown **once** during creation. The plugin stores only
  hashed keys for security. Users must save their keys immediately.
</Callout>

## Installation & Setup

```npm
npm i @re-auth/reauth
```

### Basic Configuration

```ts
import createReAuthEngine, {
  reauthDb,
  reauthDbVersions,
} from '@re-auth/reauth';
import { kyselyAdapter } from 'fumadb/adapters/kysely';
import apiKeyPlugin, { apiKeySchema } from '@re-auth/reauth/plugins/api-key';

// Setup database schema and client
const { schema: v1 } = reauthDb('1.0.1', [apiKeySchema]);
const factory = reauthDbVersions([v1]);
const client = factory.client(
  kyselyAdapter({ provider: 'sqlite', db: kysely }),
);

const engine = createReAuthEngine({
  dbClient: {
    version: async () => await client.version(),
    orm: (version: any) => client.orm(version),
  },
  plugins: [
    apiKeyPlugin({
      keyLength: 32,
      keyPrefix: 'ak_',
      defaultTtlDays: 365,
      maxKeysPerUser: 10,
      requireScopes: false,
      enableUsageTracking: false,
      cleanupIntervalMinutes: 60,
      allowedScopes: ['read', 'write', 'delete', 'admin'],
    }),
  ],
  getUserData: async (subjectId, orm) => {
    const user = await orm.findFirst('subjects', {
      where: (b) => b('id', '=', subjectId),
    });
    return user ?? {};
  },
});
```

### With Custom Scopes

```ts
apiKeyPlugin({
  keyPrefix: 'sk_', // Secret key prefix
  requireScopes: true, // Scopes are mandatory
  allowedScopes: [
    'read:users',
    'write:users',
    'read:orders',
    'write:orders',
    'read:analytics',
    'admin:all',
  ],
  maxKeysPerUser: 20,
  defaultTtlDays: 90, // Keys expire after 90 days
});
```

### With Usage Tracking

```ts
apiKeyPlugin({
  enableUsageTracking: true, // Log all API key usage
  // Usage logs can be queried for analytics
});
```

## Configuration

### ApiKeyConfig

| Option                   | Type       | Default                                | Description                                                |
| ------------------------ | ---------- | -------------------------------------- | ---------------------------------------------------------- |
| `keyLength`              | `number`   | `32`                                   | Length of generated API key. Minimum 16 for security.      |
| `keyPrefix`              | `string`   | `'ak_'`                                | Prefix for generated keys (e.g., `ak_`, `sk_`, `pk_`).     |
| `defaultTtlDays`         | `number`   | `365`                                  | Default expiration period in days (1 year). Minimum 1 day. |
| `maxKeysPerUser`         | `number`   | `10`                                   | Maximum API keys per user. Minimum 1.                      |
| `allowedScopes`          | `string[]` | `['read', 'write', 'delete', 'admin']` | Available permission scopes for keys.                      |
| `requireScopes`          | `boolean`  | `false`                                | Whether scopes are mandatory when creating keys.           |
| `enableUsageTracking`    | `boolean`  | `false`                                | Enable logging of API key usage for analytics.             |
| `cleanupIntervalMinutes` | `number`   | `60`                                   | Cleanup interval in minutes. Must be 1-1440 (1-24 hours).  |

## API Key Management

### 1. Create API Key

**Step name:** `create-api-key`  
**HTTP:** `POST /auth/api-keys`  
**Auth:** Required

Generate a new API key for the authenticated user.

**Input:**

```ts
{
  token: Token; // User session token
  name: string; // Descriptive name (e.g., "Production Server", "CI/CD Pipeline")
  permissions?: string[]; // Custom permissions (optional)
  scopes?: string[]; // Permission scopes (must be in allowedScopes)
  expires_at?: Date; // Custom expiration date
  ttl_days?: number; // Alternative to expires_at (days from now)
  others?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ip' | 'ic' | 'tl'; // success | unauthorized | invalid | too many
  message: string;
  api_key?: string; // ONLY SHOWN ONCE - must be saved immediately
  metadata?: {
    id: string;
    name: string;
    subject_id: string;
    permissions?: string[];
    scopes?: string[];
    expires_at: string | null;
    is_active: true;
    created_at: string;
    updated_at: string;
  };
  token?: Token;
  others?: Record<string, any>;
}
```

**Behavior:**

- Validates user authentication
- Checks `maxKeysPerUser` limit
- Validates scopes against `allowedScopes`
- Generates cryptographically secure API key
- Hashes key with SHA-256 before storage
- Returns plaintext key **only once**
- Sets expiration based on `ttl_days` or `expires_at` or `defaultTtlDays`

**Example:**

```ts
const result = await engine.executeStep('api-key', 'create-api-key', {
  token: userToken,
  name: 'Production API',
  scopes: ['read:users', 'write:orders'],
  ttl_days: 90,
});

if (result.success) {
  console.warn('SAVE THIS KEY - IT WILL NOT BE SHOWN AGAIN:');
  console.log(result.api_key); // e.g., ak_f8a7d9c2e1b4f6a3...

  // Store securely
  await saveToSecureVault({
    key: result.api_key,
    name: result.metadata.name,
    expires: result.metadata.expires_at,
  });
}
```

**UI Pattern: One-time display:**

```tsx
function CreateApiKeyDialog({ onClose }) {
  const [apiKey, setApiKey] = useState<string | null>(null);
  const [copied, setCopied] = useState(false);

  if (apiKey) {
    return (
      <Dialog>
        <h2>⚠️ Save Your API Key</h2>
        <p>This key will only be shown once. Copy it now:</p>
        <code className="key-display">{apiKey}</code>
        <button
          onClick={() => {
            navigator.clipboard.writeText(apiKey);
            setCopied(true);
          }}
        >
          {copied ? '✓ Copied!' : 'Copy Key'}
        </button>
        <button onClick={onClose}>I've Saved It</button>
      </Dialog>
    );
  }

  return (
    <form
      onSubmit={async (e) => {
        e.preventDefault();
        const result = await createApiKey({
          name: e.target.name.value,
          scopes: Array.from(e.target.scopes.selectedOptions).map(
            (o) => o.value,
          ),
        });
        if (result.success) {
          setApiKey(result.api_key);
        }
      }}
    >
      <input name="name" placeholder="API Key Name" required />
      <select name="scopes" multiple>
        <option value="read">Read</option>
        <option value="write">Write</option>
        <option value="admin">Admin</option>
      </select>
      <button>Generate API Key</button>
    </form>
  );
}
```

### 2. Authenticate with API Key

**Step name:** `authenticate-api-key`  
**HTTP:** `POST /auth/api-keys/authenticate`

Verify an API key and retrieve associated user.

**Input:**

```ts
{
  api_key: string; // The API key to authenticate
  others?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ip' | 'ex'; // success | invalid | expired
  message: string;
  subject?: {
    id: string;
    scopes?: string[];
    permissions?: string[];
  };
  metadata?: {
    id: string;
    name: string;
    last_used_at: string;
  };
  others?: Record<string, any>;
}
```

**Behavior:**

- Hashes provided API key
- Looks up key in database
- Checks if key is active (`is_active: true`)
- Validates key hasn't expired
- Updates `last_used_at` timestamp
- Logs usage if `enableUsageTracking: true`
- Returns subject ID and permissions

**Example:**

```ts
// Middleware for API authentication
async function apiKeyAuth(req, res, next) {
  const apiKey = req.headers['x-api-key'];

  if (!apiKey) {
    return res.status(401).json({ error: 'API key required' });
  }

  const result = await engine.executeStep('api-key', 'authenticate-api-key', {
    api_key: apiKey,
  });

  if (!result.success) {
    return res.status(401).json({ error: result.message });
  }

  // Attach user to request
  req.user = result.subject;
  req.apiKeyScopes = result.subject.scopes;

  next();
}

// Protected API endpoint
app.get('/api/users', apiKeyAuth, async (req, res) => {
  if (!req.apiKeyScopes.includes('read:users')) {
    return res.status(403).json({ error: 'Insufficient permissions' });
  }

  const users = await db.getUsers();
  res.json(users);
});
```

### 3. List API Keys

**Step name:** `list-api-keys`  
**HTTP:** `GET /auth/api-keys`  
**Auth:** Required

List all API keys for the authenticated user.

**Input:**

```ts
{
  token: Token;
  others?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ip';
  message: string;
  api_keys?: Array<{
    id: string;
    name: string;
    permissions?: string[];
    scopes?: string[];
    last_used_at: string | null;
    expires_at: string | null;
    is_active: boolean;
    created_at: string;
    updated_at: string;
  }>;
  token?: Token;
  others?: Record<string, any>;
}
```

**Example:**

```tsx
function ApiKeysList() {
  const [keys, setKeys] = useState([]);

  useEffect(() => {
    const fetchKeys = async () => {
      const result = await engine.executeStep('api-key', 'list-api-keys', {
        token: userToken,
      });
      if (result.success) {
        setKeys(result.api_keys);
      }
    };
    fetchKeys();
  }, []);

  return (
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Scopes</th>
          <th>Last Used</th>
          <th>Expires</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {keys.map((key) => (
          <tr key={key.id}>
            <td>{key.name}</td>
            <td>{key.scopes?.join(', ')}</td>
            <td>{key.last_used_at ? formatDate(key.last_used_at) : 'Never'}</td>
            <td>{key.expires_at ? formatDate(key.expires_at) : 'Never'}</td>
            <td>{key.is_active ? '✓ Active' : '✗ Revoked'}</td>
            <td>
              <button onClick={() => revokeKey(key.id)}>Revoke</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}
```

### 4. Revoke API Key

**Step name:** `revoke-api-key`  
**HTTP:** `DELETE /auth/api-keys/:id`  
**Auth:** Required

Revoke (deactivate) an API key.

**Input:**

```ts
{
  token: Token;
  api_key_id: string;
  others?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ip' | 'unf'; // success | unauthorized | not found
  message: string;
  token?: Token;
  others?: Record<string, any>;
}
```

**Example:**

```ts
const result = await engine.executeStep('api-key', 'revoke-api-key', {
  token: userToken,
  api_key_id: 'key-123',
});

if (result.success) {
  console.log('API key revoked successfully');
}
```

### 5. Update API Key

**Step name:** `update-api-key`  
**HTTP:** `PATCH /auth/api-keys/:id`  
**Auth:** Required

Update API key metadata (name, scopes, expiration).

**Input:**

```ts
{
  token: Token;
  api_key_id: string;
  name?: string;
  scopes?: string[];
  permissions?: string[];
  expires_at?: Date | null;
  others?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ip' | 'ic' | 'unf';
  message: string;
  metadata?: {
    id: string;
    name: string;
    scopes?: string[];
    permissions?: string[];
    expires_at: string | null;
    updated_at: string;
  };
  token?: Token;
  others?: Record<string, any>;
}
```

**Example:**

```ts
const result = await engine.executeStep('api-key', 'update-api-key', {
  token: userToken,
  api_key_id: 'key-123',
  name: 'Production API (Updated)',
  scopes: ['read', 'write', 'admin'],
});
```

## Background Cleanup

The plugin registers a cleanup task that runs every `cleanupIntervalMinutes` (default: 60 minutes) to mark expired API keys as inactive.

**Cleanup result structure:**

```ts
{
  cleaned: number;
  expiredKeysDisabled: number;
  errors?: string[];
}
```

<Callout title="Soft deletion" type="info">
  The cleanup task marks expired keys as `is_active: false` instead of deleting
  them. This preserves usage history and audit trails.
</Callout>

## Profile API

```ts
const profile = await engine.getUnifiedProfile('user-123');

// profile.plugins['api-key']
{
  api_keys: [
    {
      id: 'key-abc',
      name: 'Production Server',
      permissions: [],
      scopes: ['read', 'write'],
      expires_at: '2026-10-03T00:00:00Z',
      is_active: true,
      created_at: '2025-10-03T10:00:00Z',
      updated_at: '2025-10-03T10:00:00Z',
      last_used_at: '2025-10-03T14:30:00Z',
    },
  ];
}
```

## HTTP Adapter Integration

```ts
POST   /auth/api-keys                 → api-key:create-api-key (auth)
POST   /auth/api-keys/authenticate    → api-key:authenticate-api-key
GET    /auth/api-keys                 → api-key:list-api-keys (auth)
DELETE /auth/api-keys/:id             → api-key:revoke-api-key (auth)
PATCH  /auth/api-keys/:id             → api-key:update-api-key (auth)
```

## Security Best Practices

<Steps>
  <Step>
    <h4>1. Key Length</h4>
    <p>
      Use at least 32 characters (default) for strong keys. Minimum 16
      characters enforced.
    </p>
  </Step>
  <Step>
    <h4>2. Hashed Storage</h4>
    <p>
      API keys are SHA-256 hashed before storage. Raw keys are never stored in
      the database.
    </p>
  </Step>
  <Step>
    <h4>3. One-Time Display</h4>
    <p>
      Keys are shown only once during creation. Users must save them
      immediately.
    </p>
  </Step>
  <Step>
    <h4>4. Scope Minimization</h4>
    <p>
      Grant only necessary scopes. Use <code>requireScopes: true</code> to
      enforce scope specification.
    </p>
  </Step>
  <Step>
    <h4>5. Expiration</h4>
    <p>
      Set reasonable expiration periods. Default 365 days balances security and
      convenience.
    </p>
  </Step>
  <Step>
    <h4>6. Rate Limiting</h4>
    <p>
      Implement rate limiting at the HTTP adapter level to prevent API key
      abuse.
    </p>
  </Step>
  <Step>
    <h4>7. Transmission Security</h4>
    <p>
      Always use HTTPS. Send keys in <code>Authorization: Bearer</code> or{' '}
      <code>X-API-Key</code> headers, never in URLs.
    </p>
  </Step>
</Steps>

## Use Cases

### Developer API Platform

```ts
// Users generate keys for their applications
const result = await createApiKey({
  name: 'My Mobile App',
  scopes: ['read:data', 'write:data'],
  ttl_days: 365,
});

// Developers use keys to authenticate API requests
fetch('https://api.yourapp.com/data', {
  headers: {
    Authorization: `Bearer ${apiKey}`,
  },
});
```

### Microservices Authentication

```ts
// Service A authenticates to Service B
const serviceKey = process.env.SERVICE_A_API_KEY;

const response = await fetch('https://service-b.internal/endpoint', {
  headers: {
    'X-API-Key': serviceKey,
  },
});
```

### CI/CD Pipelines

```ts
// GitHub Actions workflow
- name: Deploy
  env:
    API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
  run: |
    curl -X POST https://api.yourapp.com/deploy \
      -H "Authorization: Bearer $API_KEY"
```

## Next Steps

<Cards>
  <Card
    href="/docs/engine/plugins/organization"
    title="Organization Plugin"
    description="Scope API keys to specific organizations."
  />
  <Card
    href="/docs/http-adapters"
    title="HTTP Adapters"
    description="Implement API key authentication middleware."
  />
  <Card
    href="/docs/engine/configuration"
    title="Engine Configuration"
    description="Configure cleanup intervals and key expiration."
  />
</Cards>

---
title: Phone Plugin
description: Phone number authentication with SMS verification codes.
---

## Overview

The `phone` plugin provides **phone number-based authentication** with SMS verification codes. It's perfect for mobile-first applications, international users, and scenarios where phone numbers are more reliable than email addresses.

Key features:

- **Phone Registration**: Create accounts with phone numbers
- **SMS Verification**: Verify phone numbers with SMS codes
- **Password Authentication**: Secure password-based login
- **Phone Number Changes**: Allow users to update their phone numbers
- **Password Reset**: Reset passwords via SMS codes
- **International Support**: Handle international phone number formats
- **Code Management**: Automatic cleanup of expired verification codes

<Callout title="SMS Integration Required" type="warning">
  The phone plugin requires integration with an SMS provider (Twilio, AWS SNS,
  etc.) to send verification codes. The plugin handles code generation and
  validation, but you must implement the SMS sending logic.
</Callout>

## Installation & Setup

```npm
npm i @re-auth/reauth
```

### Basic Configuration

```ts
import createReAuthEngine, {
  reauthDb,
  reauthDbVersions,
} from '@re-auth/reauth';
import { kyselyAdapter } from 'fumadb/adapters/kysely';
import phonePasswordPlugin, {
  phonePasswordSchema,
} from '@re-auth/reauth/plugins/phone';

// Setup database schema and client
const { schema: v1 } = reauthDb('1.0.1', [phonePasswordSchema]);
const factory = reauthDbVersions([v1]);
const client = factory.client(
  kyselyAdapter({ provider: 'sqlite', db: kysely }),
);

const engine = createReAuthEngine({
  dbClient: {
    version: async () => await client.version(),
    orm: (version: any) => client.orm(version),
  },
  plugins: [
    // Phone-based authentication
    phonePasswordPlugin({
      sessionTtlSeconds: 3600, // 1 hour sessions
      enableRegistration: true,

      // SMS configuration
      verificationCodeTtlMinutes: 5, // 5 minute verification codes
      verificationCodeLength: 6, // 6-digit codes
      resetCodeTtlMinutes: 15, // 15 minute reset codes
      resetCodeLength: 6, // 6-digit reset codes

      // Cleanup configuration
      cleanupIntervalMinutes: 30, // Clean up every 30 minutes

      // SMS sending function (you must implement this)
      sendSMS: async (phoneNumber: string, message: string) => {
        // Integrate with your SMS provider (Twilio, AWS SNS, etc.)
        await twilioClient.messages.create({
          body: message,
          to: phoneNumber,
          from: process.env.TWILIO_PHONE_NUMBER,
        });
      },
    }),
  ],
  getUserData: async (subjectId, orm) => {
    const user = await orm.findFirst('subjects', {
      where: (b) => b('id', '=', subjectId),
    });
    return user ?? {};
  },
});
```

### With Twilio Integration

```ts
import twilio from 'twilio';

const twilioClient = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN,
);

phonePasswordPlugin({
  sessionTtlSeconds: 7200, // 2 hour sessions
  enableRegistration: true,

  // SMS configuration
  verificationCodeTtlMinutes: 10, // 10 minute codes
  verificationCodeLength: 4, // 4-digit codes for easier entry
  resetCodeTtlMinutes: 30, // 30 minute reset codes

  // Twilio SMS integration
  sendSMS: async (phoneNumber: string, message: string) => {
    try {
      await twilioClient.messages.create({
        body: message,
        to: phoneNumber,
        from: process.env.TWILIO_PHONE_NUMBER,
      });
      console.log(`SMS sent to ${phoneNumber}: ${message}`);
    } catch (error) {
      console.error('Failed to send SMS:', error);
      throw new Error('Failed to send verification code');
    }
  },
});
```

## Configuration

### PhonePasswordConfig

| Option                       | Type       | Default  | Description                                |
| ---------------------------- | ---------- | -------- | ------------------------------------------ |
| `sessionTtlSeconds`          | `number`   | `3600`   | Session lifetime in seconds                |
| `enableRegistration`         | `boolean`  | `true`   | Allow new user registration                |
| `verificationCodeTtlMinutes` | `number`   | `5`      | Phone verification code lifetime (minutes) |
| `verificationCodeLength`     | `number`   | `6`      | Length of verification codes               |
| `resetCodeTtlMinutes`        | `number`   | `15`     | Password reset code lifetime (minutes)     |
| `resetCodeLength`            | `number`   | `6`      | Length of password reset codes             |
| `cleanupIntervalMinutes`     | `number`   | `60`     | Cleanup frequency in minutes               |
| `sendSMS`                    | `function` | Required | Function to send SMS messages              |

## Database Schema

The phone plugin extends the base ReAuth schema with phone-specific tables:

### `subjects`

User accounts with phone number authentication.

```sql
CREATE TABLE subjects (
  id UUID PRIMARY KEY,
  phone VARCHAR(20) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  phone_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  metadata JSONB
);
```

### `phone_verification_codes`

Phone number verification codes.

```sql
CREATE TABLE phone_verification_codes (
  id UUID PRIMARY KEY,
  subject_id UUID REFERENCES subjects(id) ON DELETE CASCADE,
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(10) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP NULL,
  ip_address INET,
  user_agent TEXT,
  type VARCHAR(20) DEFAULT 'verification' -- 'verification' or 'reset'
);
```

## Authentication Steps

### 1. Register

**Step name:** `register`  
**HTTP:** `POST /auth/register`  
**Auth:** Not required

Create a new user account with phone number and password. Sends verification code.

**Input:**

```ts
{
  phone: string; // Phone number in international format
  password: string; // User's password
  metadata?: Record<string, any>; // Optional user metadata
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'du' | 'alr';
  message: string;
  subject?: {
    id: string;
    phone: string;
    phone_verified: boolean;
    created_at: string;
    is_active: boolean;
  };
  token?: Token; // Session token (limited until verification)
  error?: string | object;
}
```

**Behavior:**

- Validates phone number format
- Checks for existing phone numbers
- Hashes password before storage
- Creates unverified subject record
- Sends SMS verification code
- Generates limited session token

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'register', {
  phone: '+1234567890',
  password: 'securePassword123!',
  metadata: {
    displayName: 'John Doe',
    preferredLanguage: 'en',
  },
});

if (result.success) {
  console.log('Account created for:', result.subject.phone);
  console.log('Verification code sent via SMS');
  console.log('Session token:', result.token.accessToken);

  // Store token (limited functionality until verification)
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Registration failed:', result.error);
}
```

### 2. Verify Phone

**Step name:** `verify-phone`  
**HTTP:** `POST /auth/verify-phone`  
**Auth:** Required (limited session)

Verify phone number with SMS code.

**Input:**

```ts
{
  token: Token; // Current session token
  code: string; // SMS verification code
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'aut' | 'nf';
  message: string;
  subject?: {
    id: string;
    phone: string;
    phone_verified: boolean;
    verified_at: string;
  };
  token?: Token; // Full session token after verification
  error?: string | object;
}
```

**Behavior:**

- Validates verification code
- Checks code expiration
- Marks phone as verified
- Upgrades session to full access
- Invalidates verification code

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'verify-phone', {
  token: userToken,
  code: '123456', // Code from SMS
});

if (result.success) {
  console.log('Phone verified successfully!');
  console.log('Full access granted');

  // Update stored token with full access
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Verification failed:', result.error);
}
```

### 3. Resend Verification

**Step name:** `resend-verify-phone`  
**HTTP:** `POST /auth/resend-verify-phone`  
**Auth:** Required (limited session)

Resend SMS verification code.

**Input:**

```ts
{
  token: Token; // Current session token
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'aut' | 'tl';
  message: string;
  error?: string | object;
}
```

**Behavior:**

- Validates session
- Generates new verification code
- Sends new SMS code
- Invalidates previous code

**Example:**

```ts
const result = await engine.executeStep(
  'phone-password',
  'resend-verify-phone',
  {
    token: userToken,
  },
);

if (result.success) {
  console.log('New verification code sent');
} else {
  console.log('Failed to resend code:', result.error);
}
```

### 4. Login

**Step name:** `login`  
**HTTP:** `POST /auth/login`  
**Auth:** Not required

Authenticate user with phone number and password.

**Input:**

```ts
{
  phone: string; // User's phone number
  password: string; // User's password
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'nf' | 'aut';
  message: string;
  subject?: {
    id: string;
    phone: string;
    phone_verified: boolean;
    last_login_at: string;
    is_active: boolean;
  };
  token?: Token; // Session token
  error?: string | object;
}
```

**Behavior:**

- Validates phone and password
- Checks if phone is verified
- Updates last login timestamp
- Generates session token

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'login', {
  phone: '+1234567890',
  password: 'securePassword123!',
});

if (result.success) {
  console.log('Login successful:', result.subject.phone);
  console.log('Phone verified:', result.subject.phone_verified);

  // Store token for authenticated requests
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Login failed:', result.error);
}
```

### 5. Change Password

**Step name:** `change-password`  
**HTTP:** `POST /auth/change-password`  
**Auth:** Required

Change the current user's password.

**Input:**

```ts
{
  token: Token; // Current session token
  currentPassword: string; // Current password for verification
  newPassword: string; // New password
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'aut' | 'nf';
  message: string;
  subject?: {
    id: string;
    phone: string;
    updated_at: string;
  };
  token?: Token; // Updated session token
  error?: string | object;
}
```

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'change-password', {
  token: userToken,
  currentPassword: 'oldPassword123',
  newPassword: 'newSecurePassword456!',
});

if (result.success) {
  console.log('Password changed successfully');

  // Update stored token
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Password change failed:', result.error);
}
```

### 6. Change Phone

**Step name:** `change-phone`  
**HTTP:** `POST /auth/change-phone`  
**Auth:** Required

Change the current user's phone number.

**Input:**

```ts
{
  token: Token; // Current session token
  newPhone: string; // New phone number
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'du' | 'aut';
  message: string;
  subject?: {
    id: string;
    phone: string;
    phone_verified: boolean;
    updated_at: string;
  };
  token?: Token; // Limited session token until verification
  error?: string | object;
}
```

**Behavior:**

- Validates new phone number
- Checks for existing phone numbers
- Updates phone number
- Sends verification code to new number
- Downgrades session to limited access

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'change-phone', {
  token: userToken,
  newPhone: '+1987654321',
});

if (result.success) {
  console.log('Phone number updated');
  console.log('Verification code sent to new number');

  // Session is now limited until verification
  localStorage.setItem('authToken', result.token.accessToken);

  // User must verify new phone number
  await verifyNewPhoneNumber(result.token);
}
```

### 7. Send Password Reset

**Step name:** `send-reset-password`  
**HTTP:** `POST /auth/send-reset-password`  
**Auth:** Not required

Send password reset code via SMS.

**Input:**

```ts
{
  phone: string; // User's phone number
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'nf';
  message: string;
  error?: string | object;
}
```

**Example:**

```ts
const result = await engine.executeStep(
  'phone-password',
  'send-reset-password',
  {
    phone: '+1234567890',
  },
);

if (result.success) {
  console.log('Password reset code sent via SMS');
} else {
  console.log('Failed to send reset code:', result.error);
}
```

### 8. Reset Password

**Step name:** `reset-password`  
**HTTP:** `POST /auth/reset-password`  
**Auth:** Not required

Reset password using SMS code.

**Input:**

```ts
{
  phone: string; // User's phone number
  code: string; // SMS reset code
  newPassword: string; // New password
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'nf' | 'aut';
  message: string;
  subject?: {
    id: string;
    phone: string;
    updated_at: string;
  };
  token?: Token; // Session token
  error?: string | object;
}
```

**Example:**

```ts
const result = await engine.executeStep('phone-password', 'reset-password', {
  phone: '+1234567890',
  code: '654321', // Code from SMS
  newPassword: 'brandNewPassword789!',
});

if (result.success) {
  console.log('Password reset successfully');

  // Store new session token
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Password reset failed:', result.error);
}
```

## Background Cleanup

The plugin registers cleanup tasks for expired codes:

```ts
engine.registerCleanupTask({
  name: 'expired-codes',
  pluginName: 'phone-password',
  intervalMs: 60 * 60 * 1000, // 1 hour
  enabled: true,
  runner: async (orm, config) => {
    // Clean up expired verification and reset codes
    const expiredCodes = await orm.deleteMany('phone_verification_codes', {
      where: (b) => b('expires_at', '<', new Date()),
    });

    return {
      cleaned: expiredCodes.count,
      verificationCodesDeleted: expiredCodes.count,
      resetCodesDeleted: 0, // Reset codes are in same table
    };
  },
});
```

## Profile API

The plugin exposes phone information in user profiles:

```ts
const profile = await engine.getUnifiedProfile('user-123');

// profile.plugins['phone-password']
{
  phone: '+1234567890',
  phone_verified: true,
  created_at: '2025-01-15T10:30:00Z',
  last_login_at: '2025-01-15T14:20:00Z',
  is_active: true,
  total_sessions: 3
}
```

## HTTP Adapter Integration

When using HTTP adapters, phone steps are automatically exposed:

```ts
POST /auth/register              → phone-password:register
POST /auth/verify-phone          → phone-password:verify-phone (auth)
POST /auth/resend-verify-phone   → phone-password:resend-verify-phone (auth)
POST /auth/login                 → phone-password:login
POST /auth/change-password       → phone-password:change-password (auth)
POST /auth/change-phone          → phone-password:change-phone (auth)
POST /auth/send-reset-password   → phone-password:send-reset-password
POST /auth/reset-password        → phone-password:reset-password
```

## SMS Provider Integration

### Twilio Integration

```ts
import twilio from 'twilio';

const twilioClient = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN,
);

phonePasswordPlugin({
  sendSMS: async (phoneNumber: string, message: string) => {
    try {
      const result = await twilioClient.messages.create({
        body: message,
        to: phoneNumber,
        from: process.env.TWILIO_PHONE_NUMBER,
      });
      console.log(`SMS sent: ${result.sid}`);
    } catch (error) {
      console.error('Twilio error:', error);
      throw new Error('Failed to send SMS');
    }
  },
});
```

### AWS SNS Integration

```ts
import AWS from 'aws-sdk';

const sns = new AWS.SNS({
  region: process.env.AWS_REGION,
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
});

phonePasswordPlugin({
  sendSMS: async (phoneNumber: string, message: string) => {
    try {
      const result = await sns
        .publish({
          Message: message,
          PhoneNumber: phoneNumber,
        })
        .promise();
      console.log(`SMS sent: ${result.MessageId}`);
    } catch (error) {
      console.error('AWS SNS error:', error);
      throw new Error('Failed to send SMS');
    }
  },
});
```

### Custom SMS Provider

```ts
phonePasswordPlugin({
  sendSMS: async (phoneNumber: string, message: string) => {
    // Your custom SMS provider integration
    const response = await fetch('https://api.yoursmsprovider.com/send', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${process.env.SMS_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        to: phoneNumber,
        message: message,
      }),
    });

    if (!response.ok) {
      throw new Error('Failed to send SMS');
    }

    const result = await response.json();
    console.log(`SMS sent: ${result.messageId}`);
  },
});
```

## Complete Example: Mobile App

```ts
// 1. User registers with phone number
const registerResult = await engine.executeStep('phone-password', 'register', {
  phone: '+1234567890',
  password: 'mobilePassword123!',
  metadata: {
    appVersion: '2.1.0',
    deviceType: 'iOS',
  },
});

if (registerResult.success) {
  console.log('Account created, verification code sent');

  // Show verification screen in app
  showVerificationScreen(registerResult.token);
}

// 2. User enters verification code
const verifyResult = await engine.executeStep(
  'phone-password',
  'verify-phone',
  {
    token: userToken,
    code: '123456', // From SMS
  },
);

if (verifyResult.success) {
  console.log('Phone verified, full access granted');

  // Navigate to main app screen
  navigateToMainApp(verifyResult.token);
}

// 3. User logs in later
const loginResult = await engine.executeStep('phone-password', 'login', {
  phone: '+1234567890',
  password: 'mobilePassword123!',
});

if (loginResult.success) {
  console.log('Welcome back!');

  // Restore user session
  restoreUserSession(loginResult.token);
}

// 4. User changes phone number
const changePhoneResult = await engine.executeStep(
  'phone-password',
  'change-phone',
  {
    token: userToken,
    newPhone: '+1987654321',
  },
);

if (changePhoneResult.success) {
  console.log('New verification code sent');

  // Show verification screen for new number
  showVerificationScreen(changePhoneResult.token);
}

// 5. User resets password
const resetResult = await engine.executeStep(
  'phone-password',
  'reset-password',
  {
    phone: '+1234567890',
    code: '654321', // From SMS
    newPassword: 'newSecurePassword456!',
  },
);

if (resetResult.success) {
  console.log('Password reset successfully');

  // Log user in with new password
  loginWithNewPassword(resetResult.token);
}
```

## Use Cases

### Mobile-First Application

```ts
phonePasswordPlugin({
  sessionTtlSeconds: 86400, // 24 hour sessions
  verificationCodeTtlMinutes: 10, // 10 minute codes
  verificationCodeLength: 4, // 4-digit codes for mobile
  resetCodeTtlMinutes: 30, // 30 minute reset codes
  cleanupIntervalMinutes: 15, // Frequent cleanup
});
```

### International Service

```ts
phonePasswordPlugin({
  sessionTtlSeconds: 7200, // 2 hour sessions
  verificationCodeTtlMinutes: 5, // Short-lived codes
  verificationCodeLength: 6, // 6-digit codes
  resetCodeTtlMinutes: 15, // Quick reset
  cleanupIntervalMinutes: 30, // Standard cleanup
});
```

### High-Security Application

```ts
phonePasswordPlugin({
  sessionTtlSeconds: 1800, // 30 minute sessions
  verificationCodeTtlMinutes: 3, // Very short codes
  verificationCodeLength: 8, // Longer codes
  resetCodeTtlMinutes: 10, // Short reset window
  cleanupIntervalMinutes: 5, // Very frequent cleanup
});
```

## Next Steps

<Cards>
  <Card
    href="/docs/engine/plugins/session"
    title="Session Plugin"
    description="Add enhanced session management capabilities."
  />
  <Card
    href="/docs/engine/plugins/admin"
    title="Admin Plugin"
    description="Manage users through admin interface."
  />
  <Card
    href="/docs/engine/plugins/jwt"
    title="JWT Plugin"
    description="Use JWT tokens for stateless authentication."
  />
</Cards>

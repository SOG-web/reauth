---
title: Email + Password Plugin
description: Traditional email/password authentication with verification codes and password resets.
---

## Overview

The `email-password` plugin provides classic form-based authentication with email verification and password reset flows. It manages:

- Email/password registration with optional verification
- Login with credential validation
- Email verification via codes (numeric, alphanumeric, or alphabet)
- Password reset requests and confirmation
- Password and email changes for authenticated users
- Background cleanup of expired verification/reset codes

<Callout title="Production-ready defaults" type="success">
  The plugin ships with sensible defaults for TTLs, code expiration, and cleanup
  intervals. Override only what your app requires.
</Callout>

## Installation & Setup

```npm
npm i @re-auth/reauth
```

```ts lineNumbers
import createReAuthEngine, {
  reauthDb,
  reauthDbVersions,
} from '@re-auth/reauth';
import { kyselyAdapter } from 'fumadb/adapters/kysely';
import emailPasswordPlugin, {
  emailPasswordSchema,
} from '@re-auth/reauth/plugins/email-password';

// Setup database schema and client
const { schema: v1 } = reauthDb('1.0.1', [emailPasswordSchema]);
const factory = reauthDbVersions([v1]);
const client = factory.client(
  kyselyAdapter({ provider: 'sqlite', db: kysely }),
);

const engine = createReAuthEngine({
  dbClient: {
    version: async () => await client.version(),
    orm: (version: any) => client.orm(version),
  },
  plugins: [
    emailPasswordPlugin({
      sendCode(subject, code, email, type) {
        console.log(`Sending ${type} code to ${email}:`, code);
        // Implement your email sending logic here
        return Promise.resolve();
      },
      verifyEmail: true,
    }),
  ],
  getUserData: async (subjectId, orm) => {
    return { id: subjectId };
  },
});
```

## Configuration

### EmailPasswordConfig

| Option                       | Type                                                | Default     | Description                                                                        |
| ---------------------------- | --------------------------------------------------- | ----------- | ---------------------------------------------------------------------------------- |
| `verifyEmail`                | `boolean`                                           | `false`     | If `true`, require email verification before allowing login.                       |
| `sendCode`                   | `(subject, code, email, type) => Promise<void>`     | -           | **Required** if `verifyEmail: true`. Function to send verification/reset codes.    |
| `loginOnRegister`            | `boolean`                                           | `true`      | Automatically log in the user after successful registration.                       |
| `sessionTtlSeconds`          | `number`                                            | `3600`      | Session token TTL in seconds.                                                      |
| `codeType`                   | `'numeric' \| 'alphanumeric' \| 'alphabet'`         | `'numeric'` | Type of verification/reset code to generate.                                       |
| `codeLength`                 | `number`                                            | `6`         | Length of generated codes.                                                         |
| `generateCode`               | `(email, subject?) => Promise<string \| number>`    | -           | Optional custom code generator. Overrides `codeType` and `codeLength`.             |
| `verificationCodeExpiresIn`  | `number`                                            | `1800000`   | Verification code expiration in milliseconds (default 30 minutes).                 |
| `resetPasswordCodeExpiresIn` | `number`                                            | `900000`    | Password reset code expiration in milliseconds (default 15 minutes).               |
| `cleanupIntervalMinutes`     | `number`                                            | `60`        | Interval (in minutes) between background cleanup runs. Must be between 1 and 1440. |
| `testUsers`                  | `{ enabled, users, environment, checkEnvironment }` | -           | Optional test user configuration for development/testing environments.             |

<Callout title="Verification requirement" type="warn">
  When `verifyEmail: true`, you **must** provide the `sendCode` function. The
  plugin will throw an initialization error otherwise.
</Callout>

## Authentication Steps

The plugin exposes eight steps for different flows:

### 1. Register

**Step name:** `register`  
**HTTP:** `POST /auth/register`

Register a new user with email and password.

**Input:**

```ts
{
  email: string;
  password: string;
  profile?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'eq' | 'ev'; // success | email exists | email verification sent
  message: string;
  token?: Token; // if loginOnRegister: true
  subject?: any;
}
```

**Behavior:**

- Creates a `subject` record and `identity` with provider `'email'`
- Hashes the password using bcrypt (10 rounds)
- If `verifyEmail: true`, sends a verification code and returns `status: 'ev'`
- If `loginOnRegister: true` and email doesn't require verification, issues a session token

**Example:**

```ts
const result = await engine.executeStep('email-password', 'register', {
  email: 'user@example.com',
  password: 'SecurePass123!',
  profile: { name: 'John Doe' },
});

if (result.status === 'ev') {
  console.log('Verification code sent. Check your email.');
} else if (result.success && result.token) {
  console.log('Registered and logged in:', result.token);
}
```

### 2. Login

**Step name:** `login`  
**HTTP:** `POST /auth/login`

Authenticate with email and password.

**Input:**

```ts
{
  email: string;
  password: string;
  deviceInfo?: Record<string, any>;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'unf' | 'unv'; // success | invalid credentials | user not found | unverified
  message: string;
  token?: Token;
  subject?: any;
}
```

**Behavior:**

- Validates email/password against stored hash
- If `verifyEmail: true` and email not verified, returns `status: 'unv'`
- Issues session token on success

**Example:**

```ts
const result = await engine.executeStep('email-password', 'login', {
  email: 'user@example.com',
  password: 'SecurePass123!',
});

if (result.status === 'unv') {
  console.log('Email not verified. Please verify first.');
} else if (result.success) {
  console.log('Logged in:', result.token);
}
```

### 3. Verify Email

**Step name:** `verify-email`  
**HTTP:** `POST /auth/verify-email`

Verify email using a previously sent code.

**Input:**

```ts
{
  email: string;
  code: string | number;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'exp' | 'unf'; // success | invalid code | expired | user not found
  message: string;
  token?: Token; // if loginOnRegister: true
  subject?: any;
}
```

**Behavior:**

- Marks the identity as verified
- Deletes the verification code
- If `loginOnRegister: true`, issues a session token

**Example:**

```ts
const result = await engine.executeStep('email-password', 'verify-email', {
  email: 'user@example.com',
  code: '123456',
});

if (result.status === 'exp') {
  console.log('Code expired. Request a new one.');
} else if (result.success) {
  console.log('Email verified!', result.token);
}
```

### 4. Resend Verification

**Step name:** `resend-verification`  
**HTTP:** `POST /auth/resend-verification`

Request a new verification code.

**Input:**

```ts
{
  email: string;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'unf' | 'av'; // success | user not found | already verified
  message: string;
}
```

**Behavior:**

- Generates a new verification code
- Deletes old verification codes for the email
- Calls `sendCode(subject, code, email, 'verify')`

### 5. Send Password Reset

**Step name:** `send-reset`  
**HTTP:** `POST /auth/send-reset`

Send a password reset code to the user's email.

**Input:**

```ts
{
  email: string;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'unf'; // success | user not found
  message: string;
}
```

**Behavior:**

- Generates a reset code and stores it with expiration
- Calls `sendCode(subject, code, email, 'reset')`

### 6. Reset Password

**Step name:** `reset-password`  
**HTTP:** `POST /auth/reset-password`

Reset password using the emailed code.

**Input:**

```ts
{
  email: string;
  code: string | number;
  newPassword: string;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'exp' | 'unf'; // success | invalid code | expired | user not found
  message: string;
}
```

**Behavior:**

- Validates reset code and expiration
- Hashes new password and updates credentials
- Deletes the reset code

### 7. Change Password

**Step name:** `change-password`  
**HTTP:** `POST /auth/change-password`  
**Requires:** Authentication token

Change password for an authenticated user.

**Input:**

```ts
{
  token: Token;
  currentPassword: string;
  newPassword: string;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'unf'; // success | invalid current password | user not found
  message: string;
}
```

**Behavior:**

- Verifies current password
- Hashes and updates to new password

### 8. Change Email

**Step name:** `change-email`  
**HTTP:** `POST /auth/change-email`  
**Requires:** Authentication token

Change the primary email for an authenticated user.

**Input:**

```ts
{
  token: Token;
  newEmail: string;
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'eq' | 'ev' | 'unf'; // success | email exists | verification sent | user not found
  message: string;
}
```

**Behavior:**

- Creates a new identity with the new email
- If `verifyEmail: true`, sends verification code before allowing login with new email

## Background Cleanup

The plugin registers a cleanup task that runs every `cleanupIntervalMinutes` (default 60 minutes) to delete expired verification and reset codes.

**Cleanup behavior:**

- Deletes `verification_codes` where `expires_at < NOW()`
- Deletes `reset_codes` where `expires_at < NOW()`
- Returns count of deleted records for monitoring

**Disable cleanup:**

```ts
const engine = createReAuthEngine({
  // ...
  enableCleanupScheduler: false, // disables all cleanup tasks
});
```

**Adjust interval:**

```ts
emailPasswordPlugin({
  cleanupIntervalMinutes: 120, // cleanup every 2 hours
  // ...
});
```

<Callout title="Cleanup constraints" type="info">
  `cleanupIntervalMinutes` must be between 1 and 1440 (24 hours). The plugin
  validates this on initialization.
</Callout>

## Profile API

The plugin exposes a `getProfile` method for retrieving user email and password status:

```ts
const profile = await engine.getUnifiedProfile('user-123');

// profile.plugins['email-password']
{
  emails: [
    {
      email: 'user@example.com',
      verified: true,
      pendingVerification: false,
      created_at: '2025-10-03T12:00:00Z',
      updated_at: '2025-10-03T12:00:00Z'
    }
  ],
  password: {
    set: true
  }
}
```

## Test Users (Development)

For testing without email infrastructure:

```ts
emailPasswordPlugin({
  testUsers: {
    enabled: true,
    environment: process.env.NODE_ENV || 'development',
    checkEnvironment: (env) => env === 'development',
    users: [
      {
        email: 'test@example.com',
        password: 'testpass',
        profile: { name: 'Test User' },
      },
    ],
  },
  // ...
});
```

Test users bypass verification and always authenticate successfully when `checkEnvironment` returns `true`.

<Callout title="Security warning" type="error">
  **Never enable test users in production.** Ensure `checkEnvironment` strictly
  gates this feature to development/staging environments.
</Callout>

## HTTP Adapter Integration

When using HTTP adapters, steps are automatically exposed as REST endpoints:

```ts
POST /auth/register        → email-password:register
POST /auth/login           → email-password:login
POST /auth/verify-email    → email-password:verify-email
POST /auth/resend-verification → email-password:resend-verification
POST /auth/send-reset      → email-password:send-reset
POST /auth/reset-password  → email-password:reset-password
POST /auth/change-password → email-password:change-password (requires auth)
POST /auth/change-email    → email-password:change-email (requires auth)
```

## Next Steps

<Cards>
  <Card
    href="/docs/engine/plugins/passwordless"
    title="Passwordless Plugin"
    description="Add magic links or WebAuthn for frictionless authentication."
  />
  <Card
    href="/docs/engine/configuration"
    title="Engine Configuration"
    description="Configure session TTLs, cleanup intervals, and plugin order."
  />
  <Card
    href="/docs/http-adapters/overview"
    title="HTTP Adapters"
    description="Expose authentication flows over Express, Fastify, or Hono."
  />
</Cards>

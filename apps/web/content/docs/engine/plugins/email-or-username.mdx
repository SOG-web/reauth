---
title: Email or Username Plugin
description: Flexible authentication supporting both email and username login methods.
---

## Overview

The `email-or-username` plugin provides **flexible authentication** that supports both email and username login methods. It automatically detects whether a user is providing an email address or username and routes the authentication to the appropriate underlying plugin.

Key features:

- **Dual Authentication**: Support both email and username login
- **Automatic Detection**: Automatically detect email vs username format
- **Unified Interface**: Single API for both authentication methods
- **Flexible Registration**: Allow users to choose email or username
- **Shared Sessions**: Unified session management across both methods
- **Password Management**: Consistent password operations

<Callout title="Requires Both Plugins" type="warning">
  The email-or-username plugin requires both the email-password and
  username-password plugins to be registered. It acts as a unified interface
  over both plugins.
</Callout>

## Installation & Setup

```npm
npm i @re-auth/reauth
```

### Basic Configuration

```ts
import createReAuthEngine, {
  reauthDb,
  reauthDbVersions,
} from '@re-auth/reauth';
import { kyselyAdapter } from 'fumadb/adapters/kysely';
import emailOrUsernamePlugin, {
  emailOrUsernameSchema,
} from '@re-auth/reauth/plugins/email-or-username';
import emailPasswordPlugin, {
  emailPasswordSchema,
} from '@re-auth/reauth/plugins/email-password';
import usernamePasswordPlugin, {
  usernamePasswordSchema,
} from '@re-auth/reauth/plugins/username';

// Setup database schema and client
const { schema: v1 } = reauthDb('1.0.1', [
  emailPasswordSchema,
  usernamePasswordSchema,
  emailOrUsernameSchema,
]);
const factory = reauthDbVersions([v1]);
const client = factory.client(
  kyselyAdapter({ provider: 'sqlite', db: kysely }),
);

const engine = createReAuthEngine({
  dbClient: {
    version: async () => await client.version(),
    orm: (version: any) => client.orm(version),
  },
  plugins: [
    // Required: Email-password plugin
    emailPasswordPlugin({
      sessionTtlSeconds: 3600,
      enableRegistration: true,
      verifyEmail: false, // Disable email verification for simplicity
    }),

    // Required: Username-password plugin
    usernamePasswordPlugin({
      sessionTtlSeconds: 3600,
      enableRegistration: true,
    }),

    // Unified email-or-username plugin
    emailOrUsernamePlugin({
      sessionTtlSeconds: 3600,
      detectionStrategy: 'auto', // Automatically detect email vs username
      allowBothTypes: false, // Don't allow users to have both email and username
      loginOnRegister: true, // Automatically log in after registration
    }),
  ],
  getUserData: async (subjectId, orm) => {
    const user = await orm.findFirst('subjects', {
      where: (b) => b('id', '=', subjectId),
    });
    return user ?? {};
  },
});
```

### With Email Verification

```ts
emailOrUsernamePlugin({
  sessionTtlSeconds: 7200, // 2 hour sessions
  detectionStrategy: 'auto',
  allowBothTypes: false,
  loginOnRegister: true,

  // Email-specific configuration
  emailConfig: {
    verifyEmail: true, // Enable email verification
    loginOnRegister: false, // Don't auto-login until email verified
    verificationCodeTtlMinutes: 15,
  },

  // Username-specific configuration
  usernameConfig: {
    enableResetByUsername: true,
    resetCodeTtlMinutes: 10,
  },
});
```

### With Both Email and Username Allowed

```ts
emailOrUsernamePlugin({
  sessionTtlSeconds: 3600,
  detectionStrategy: 'auto',
  allowBothTypes: true, // Allow users to have both email and username
  loginOnRegister: true,

  emailConfig: {
    verifyEmail: false,
  },

  usernameConfig: {
    enableResetByUsername: false,
  },
});
```

## Configuration

### EmailOrUsernameConfig

| Option              | Type      | Default  | Description                                          |
| ------------------- | --------- | -------- | ---------------------------------------------------- |
| `detectionStrategy` | `string`  | `'auto'` | How to detect email vs username ('auto' or 'manual') |
| `allowBothTypes`    | `boolean` | `false`  | Allow users to have both email and username          |
| `sessionTtlSeconds` | `number`  | `3600`   | Session lifetime in seconds                          |
| `loginOnRegister`   | `boolean` | `true`   | Automatically log in after registration              |
| `emailConfig`       | `object`  | `{}`     | Configuration for email-password plugin              |
| `usernameConfig`    | `object`  | `{}`     | Configuration for username-password plugin           |

### EmailConfig

| Option                       | Type      | Default | Description                         |
| ---------------------------- | --------- | ------- | ----------------------------------- |
| `verifyEmail`                | `boolean` | `false` | Enable email verification           |
| `loginOnRegister`            | `boolean` | `true`  | Auto-login after email registration |
| `verificationCodeTtlMinutes` | `number`  | `15`    | Email verification code lifetime    |

### UsernameConfig

| Option                  | Type      | Default | Description                        |
| ----------------------- | --------- | ------- | ---------------------------------- |
| `enableResetByUsername` | `boolean` | `false` | Enable password reset via username |
| `resetCodeTtlMinutes`   | `number`  | `15`    | Password reset code lifetime       |

## Database Schema

The email-or-username plugin uses the database schemas from both underlying plugins:

### `subjects` (Email Users)

```sql
CREATE TABLE subjects (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  email_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  metadata JSONB
);
```

### `subjects` (Username Users)

```sql
CREATE TABLE subjects (
  id UUID PRIMARY KEY,
  username VARCHAR(50) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  metadata JSONB
);
```

## Authentication Steps

### 1. Register

**Step name:** `register`  
**HTTP:** `POST /auth/register`  
**Auth:** Not required

Create a new user account with either email or username.

**Input:**

```ts
{
  email?: string; // Email address (optional if username provided)
  username?: string; // Username (optional if email provided)
  password: string; // User's password
  metadata?: Record<string, any>; // Optional user metadata
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'du' | 'alr';
  message: string;
  subject?: {
    id: string;
    email?: string;
    username?: string;
    email_verified?: boolean;
    created_at: string;
    is_active: boolean;
  };
  token?: Token; // Session token
  error?: string | object;
}
```

**Behavior:**

- Detects whether email or username is provided
- Routes to appropriate underlying plugin
- Creates user account
- Generates session token (if loginOnRegister is true)

**Example:**

```ts
// Register with email
const emailResult = await engine.executeStep('email-or-username', 'register', {
  email: 'user@example.com',
  password: 'securePassword123!',
  metadata: {
    displayName: 'John Doe',
    preferredMethod: 'email',
      },
    });

if (emailResult.success) {
  console.log('Email account created:', emailResult.subject.email);
  console.log('Session token:', emailResult.token.accessToken);
}

// Register with username
const usernameResult = await engine.executeStep(
  'email-or-username',
  'register',
  {
    username: 'gamer123',
    password: 'securePassword123!',
    metadata: {
      displayName: 'Pro Gamer',
      preferredMethod: 'username',
    },
  },
);

if (usernameResult.success) {
  console.log('Username account created:', usernameResult.subject.username);
  console.log('Session token:', usernameResult.token.accessToken);
}
```

### 2. Login

**Step name:** `login`  
**HTTP:** `POST /auth/login`  
**Auth:** Not required

Authenticate user with either email or username.

**Input:**

```ts
{
  email?: string; // Email address (optional if username provided)
  username?: string; // Username (optional if email provided)
  password: string; // User's password
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'nf' | 'aut';
  message: string;
  subject?: {
    id: string;
    email?: string;
    username?: string;
    email_verified?: boolean;
    last_login_at: string;
    is_active: boolean;
  };
  token?: Token; // Session token
  error?: string | object;
}
```

**Behavior:**

- Automatically detects email vs username format
- Routes to appropriate underlying plugin
- Validates credentials
- Generates session token

**Example:**

```ts
// Login with email
const emailLogin = await engine.executeStep('email-or-username', 'login', {
  email: 'user@example.com',
  password: 'securePassword123!',
});

if (emailLogin.success) {
  console.log('Email login successful:', emailLogin.subject.email);
  localStorage.setItem('authToken', emailLogin.token.accessToken);
}

// Login with username
const usernameLogin = await engine.executeStep('email-or-username', 'login', {
  username: 'gamer123',
  password: 'securePassword123!',
});

if (usernameLogin.success) {
  console.log('Username login successful:', usernameLogin.subject.username);
  localStorage.setItem('authToken', usernameLogin.token.accessToken);
}

// Auto-detection (recommended approach)
const autoLogin = await engine.executeStep('email-or-username', 'login', {
  email: 'user@example.com', // or username: 'gamer123'
  password: 'securePassword123!',
});

// Plugin automatically detects whether it's an email or username
if (autoLogin.success) {
  console.log(
    'Login successful with:',
    autoLogin.subject.email || autoLogin.subject.username,
  );
  localStorage.setItem('authToken', autoLogin.token.accessToken);
}
```

### 3. Change Password

**Step name:** `change-password`  
**HTTP:** `POST /auth/change-password`  
**Auth:** Required

Change the current user's password.

**Input:**

```ts
{
  token: Token; // Current session token
  currentPassword: string; // Current password for verification
  newPassword: string; // New password
}
```

**Output:**

```ts
{
  success: boolean;
  status: 'su' | 'ic' | 'aut' | 'nf';
  message: string;
  subject?: {
    id: string;
    email?: string;
    username?: string;
    updated_at: string;
  };
  token?: Token; // Updated session token
  error?: string | object;
}
```

**Example:**

```ts
const result = await engine.executeStep(
  'email-or-username',
  'change-password',
  {
    token: userToken,
    currentPassword: 'oldPassword123',
    newPassword: 'newSecurePassword456!',
  },
);

if (result.success) {
  console.log('Password changed successfully');
  console.log('Updated user:', result.subject.email || result.subject.username);

  // Update stored token
  localStorage.setItem('authToken', result.token.accessToken);
} else {
  console.log('Password change failed:', result.error);
}
```

## Detection Strategies

### Automatic Detection

```ts
emailOrUsernamePlugin({
  detectionStrategy: 'auto', // Automatically detect email vs username
});

// Plugin automatically detects format:
// user@example.com → email authentication
// gamer123 → username authentication
```

### Manual Detection

```ts
emailOrUsernamePlugin({
  detectionStrategy: 'manual', // Require explicit specification
});

// Must specify which type:
const result = await engine.executeStep('email-or-username', 'login', {
  email: 'user@example.com', // Explicitly specify email
  password: 'password123',
});

// OR

const result = await engine.executeStep('email-or-username', 'login', {
  username: 'gamer123', // Explicitly specify username
  password: 'password123',
});
```

## Profile API

The plugin exposes user information in profiles:

```ts
const profile = await engine.getUnifiedProfile('user-123');

// profile.plugins['email-or-username']
{
  email: 'user@example.com', // Present if user registered with email
  username: undefined, // Present if user registered with username
  email_verified: true, // Present for email users
  created_at: '2025-01-15T10:30:00Z',
  last_login_at: '2025-01-15T14:20:00Z',
  is_active: true,
  authentication_method: 'email', // 'email' or 'username'
  total_sessions: 3
}
```

## HTTP Adapter Integration

When using HTTP adapters, email-or-username steps are automatically exposed:

```ts
POST /auth/register         → email-or-username:register
POST /auth/login           → email-or-username:login
POST /auth/change-password → email-or-username:change-password (auth)
```

## Complete Example: Flexible Authentication

```ts
// 1. User registers with email
const emailRegister = await engine.executeStep(
  'email-or-username',
  'register',
  {
    email: 'john@company.com',
    password: 'workPassword123!',
    metadata: {
      department: 'Engineering',
      role: 'Developer',
    },
  },
);

if (emailRegister.success) {
  console.log('Work account created with email');

  // Store session for immediate use
  localStorage.setItem('workToken', emailRegister.token.accessToken);
}

// 2. User registers with username for personal use
const usernameRegister = await engine.executeStep(
  'email-or-username',
  'register',
  {
    username: 'johnnygamer',
    password: 'gamingPassword456!',
    metadata: {
      gamingLevel: 'Expert',
      favoriteGame: 'Space Adventure',
    },
  },
);

if (usernameRegister.success) {
  console.log('Personal account created with username');

  // Store session for gaming
  localStorage.setItem('gamingToken', usernameRegister.token.accessToken);
}

// 3. User logs in with either method
const loginMethods = [
  { email: 'john@company.com', password: 'workPassword123!' },
  { username: 'johnnygamer', password: 'gamingPassword456!' },
];

for (const method of loginMethods) {
  const loginResult = await engine.executeStep(
    'email-or-username',
    'login',
    method,
  );

  if (loginResult.success) {
    const authMethod = loginResult.subject.email ? 'email' : 'username';
    console.log(
      `Logged in with ${authMethod}:`,
      loginResult.subject.email || loginResult.subject.username,
    );

    // Store appropriate token
    const tokenKey = authMethod === 'email' ? 'workToken' : 'gamingToken';
    localStorage.setItem(tokenKey, loginResult.token.accessToken);
  }
}

// 4. Unified password management
const changePassword = async (
  token: string,
  currentPassword: string,
  newPassword: string,
) => {
  const result = await engine.executeStep(
    'email-or-username',
    'change-password',
    {
      token,
      currentPassword,
      newPassword,
    },
  );

  if (result.success) {
    const authMethod = result.subject.email ? 'email' : 'username';
    console.log(`Password updated for ${authMethod} account`);

    // Update stored token
    const tokenKey = authMethod === 'email' ? 'workToken' : 'gamingToken';
    localStorage.setItem(tokenKey, result.token.accessToken);
  }

  return result;
};

// Change password for work account
await changePassword(workToken, 'workPassword123!', 'newWorkPassword789!');

// Change password for gaming account
await changePassword(
  gamingToken,
  'gamingPassword456!',
  'newGamingPassword012!',
);
```

## Use Cases

### Business Application

```ts
emailOrUsernamePlugin({
  sessionTtlSeconds: 28800, // 8 hour work sessions
  detectionStrategy: 'auto',
  allowBothTypes: false, // One account per user
  loginOnRegister: true,

  emailConfig: {
    verifyEmail: true, // Verify work emails
    verificationCodeTtlMinutes: 30,
  },

  usernameConfig: {
    enableResetByUsername: false, // Use email for password reset
  },
});
```

### Gaming Platform

```ts
emailOrUsernamePlugin({
  sessionTtlSeconds: 86400, // 24 hour gaming sessions
  detectionStrategy: 'auto',
  allowBothTypes: true, // Allow both email and username
  loginOnRegister: true,

  emailConfig: {
    verifyEmail: false, // No email verification needed
  },

  usernameConfig: {
    enableResetByUsername: true, // Allow username-based reset
    resetCodeTtlMinutes: 10,
  },
});
```

### Social Platform

```ts
emailOrUsernamePlugin({
  sessionTtlSeconds: 7200, // 2 hour sessions
  detectionStrategy: 'auto',
  allowBothTypes: false, // One identity per user
  loginOnRegister: true,

  emailConfig: {
    verifyEmail: true, // Verify emails for security
    verificationCodeTtlMinutes: 15,
  },

  usernameConfig: {
    enableResetByUsername: true, // Flexible password reset
    resetCodeTtlMinutes: 15,
  },
});
```

## Migration Strategy

### From Email-Only to Flexible

```ts
// Step 1: Add username plugin alongside email plugin
const engine = createReAuthEngine({
  plugins: [
    emailPasswordPlugin({
      /* existing config */
    }),
    usernamePasswordPlugin({
      /* new config */
    }),
    emailOrUsernamePlugin({
      /* unified config */
    }),
  ],
});

// Step 2: Existing users continue using email
// Step 3: New users can choose email or username
// Step 4: Gradually migrate users who want usernames
```

### From Username-Only to Flexible

```ts
// Step 1: Add email plugin alongside username plugin
const engine = createReAuthEngine({
  plugins: [
    usernamePasswordPlugin({
      /* existing config */
    }),
    emailPasswordPlugin({
      /* new config */
    }),
    emailOrUsernamePlugin({
      /* unified config */
    }),
  ],
});

// Step 2: Existing users continue using username
// Step 3: New users can choose email or username
// Step 4: Allow users to add email to existing username accounts
```

## Next Steps

<Cards>
  <Card
    href="/docs/engine/plugins/email-password"
    title="Email + Password Plugin"
    description="Learn about email-based authentication features."
  />
  <Card
    href="/docs/engine/plugins/username"
    title="Username Plugin"
    description="Learn about username-based authentication features."
  />
  <Card
    href="/docs/engine/plugins/session"
    title="Session Plugin"
    description="Add enhanced session management capabilities."
  />
</Cards>
